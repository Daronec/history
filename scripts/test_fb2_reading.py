#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á—Ç–µ–Ω–∏—è FB2 —Ñ–∞–π–ª–æ–≤
"""

import sys
import os
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ src –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π
sys.path.insert(0, str(Path(__file__).parent.parent / "src"))

from data_processing import load_fb2_file, load_file
import logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')
logger = logging.getLogger(__name__)

def test_fb2_reading():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —á—Ç–µ–Ω–∏–µ FB2 —Ñ–∞–π–ª–æ–≤"""
    logger.info("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á—Ç–µ–Ω–∏—è FB2 —Ñ–∞–π–ª–æ–≤")
    logger.info("=" * 50)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ FB2 —Ñ–∞–π–ª—ã –≤ data/raw
    data_dir = Path("data/raw")
    if not data_dir.exists():
        logger.error(f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è {data_dir} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
        return
    
    # –ò—â–µ–º FB2 —Ñ–∞–π–ª—ã
    fb2_files = list(data_dir.glob("*.fb2"))
    
    if not fb2_files:
        logger.warning("FB2 —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ data/raw")
        logger.info("–°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π FB2 —Ñ–∞–π–ª...")
        create_test_fb2_file()
        fb2_files = list(data_dir.glob("*.fb2"))
    
    if not fb2_files:
        logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π FB2 —Ñ–∞–π–ª")
        return
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π FB2 —Ñ–∞–π–ª
    for fb2_file in fb2_files:
        logger.info(f"\nüìñ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª: {fb2_file.name}")
        logger.info("-" * 30)
        
        try:
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–µ —á—Ç–µ–Ω–∏–µ FB2
            text = load_fb2_file(fb2_file)
            
            if text:
                logger.info(f"‚úÖ FB2 —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω")
                logger.info(f"üìä –†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞: {len(text):,} —Å–∏–º–≤–æ–ª–æ–≤")
                logger.info(f"üìù –ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤:")
                logger.info(f"   {text[:200]}...")
                
                # –¢–µ—Å—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é load_file
                text_via_load_file = load_file(fb2_file)
                if text_via_load_file == text:
                    logger.info("‚úÖ –§—É–Ω–∫—Ü–∏—è load_file —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
                else:
                    logger.warning("‚ö†Ô∏è –†–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É load_fb2_file –∏ load_file")
            else:
                logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å FB2 —Ñ–∞–π–ª")
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ FB2 —Ñ–∞–π–ª–∞: {e}")
    
    logger.info("\n" + "=" * 50)
    logger.info("‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ FB2 –∑–∞–≤–µ—Ä—à–µ–Ω–æ")

def create_test_fb2_file():
    """–°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–π FB2 —Ñ–∞–π–ª"""
    test_fb2_content = '''<?xml version="1.0" encoding="utf-8"?>
<FictionBook xmlns="http://www.gribuser.ru/xml/fictionbook/2.0" xmlns:l="http://www.w3.org/1999/xlink">
<description>
    <title-info>
        <genre>history</genre>
        <author>
            <first-name>–¢–µ—Å—Ç–æ–≤—ã–π</first-name>
            <last-name>–ê–≤—Ç–æ—Ä</last-name>
        </author>
        <book-title>–¢–µ—Å—Ç–æ–≤–∞—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –∫–Ω–∏–≥–∞</book-title>
        <annotation>
            <p>–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è –∫–Ω–∏–≥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–µ–Ω–∏—è FB2 —Ñ–∞–π–ª–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ –ò–ò-–ò—Å—Ç–æ—Ä–∏—è.</p>
        </annotation>
        <date value="2024-01-01">2024</date>
        <lang>ru</lang>
    </title-info>
</description>
<body>
    <title>
        <p>–ì–ª–∞–≤–∞ 1. –í–≤–µ–¥–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é</p>
    </title>
    <section>
        <title>
            <p>1.1. –î—Ä–µ–≤–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∞</p>
        </title>
        <p>–ò—Å—Ç–æ—Ä–∏—è ‚Äî —ç—Ç–æ –Ω–∞—É–∫–∞, –∏–∑—É—á–∞—é—â–∞—è –ø—Ä–æ—à–ª–æ–µ —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–∞. –û–Ω–∞ –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞–º –ø–æ–Ω—è—Ç—å, –∫–∞–∫ —Ä–∞–∑–≤–∏–≤–∞–ª–æ—Å—å –æ–±—â–µ—Å—Ç–≤–æ, –∫–∞–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∏ –≤ —Ä–∞–∑–Ω—ã–µ —ç–ø–æ—Ö–∏.</p>
        <p>–î—Ä–µ–≤–Ω–∏–µ —Ü–∏–≤–∏–ª–∏–∑–∞—Ü–∏–∏ –æ—Å—Ç–∞–≤–∏–ª–∏ –Ω–∞–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –∏ –ø–∏—Å—å–º–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤. –ê—Ä—Ö–µ–æ–ª–æ–≥–∏ –∏ –∏—Å—Ç–æ—Ä–∏–∫–∏ –∏–∑—É—á–∞—é—Ç —ç—Ç–∏ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω—É –ø—Ä–æ—à–ª–æ–≥–æ.</p>
        
        <title>
            <p>1.2. –°—Ä–µ–¥–Ω–∏–µ –≤–µ–∫–∞</p>
        </title>
        <p>–°—Ä–µ–¥–Ω–∏–µ –≤–µ–∫–∞ ‚Äî —ç—Ç–æ –ø–µ—Ä–∏–æ–¥ –µ–≤—Ä–æ–ø–µ–π—Å–∫–æ–π –∏—Å—Ç–æ—Ä–∏–∏ —Å V –ø–æ XV –≤–µ–∫. –í —ç—Ç–æ –≤—Ä–µ–º—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∏ –≤–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ–ª–∏—Ç–∏–∫–µ, —ç–∫–æ–Ω–æ–º–∏–∫–µ –∏ –∫—É–ª—å—Ç—É—Ä–µ.</p>
        <p>–§–µ–æ–¥–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞, –∫—Ä–µ—Å—Ç–æ–≤—ã–µ –ø–æ—Ö–æ–¥—ã, —Ä–∞–∑–≤–∏—Ç–∏–µ –≥–æ—Ä–æ–¥–æ–≤ ‚Äî –≤—Å–µ —ç—Ç–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏–∑–æ–≤–∞–ª–æ —Å—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—É—é —ç–ø–æ—Ö—É.</p>
        
        <title>
            <p>1.3. –ù–æ–≤–æ–µ –≤—Ä–µ–º—è</p>
        </title>
        <p>–ù–æ–≤–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–æ—Å—å —Å —ç–ø–æ—Ö–∏ –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–æ—Å—å –¥–æ –∫–æ–Ω—Ü–∞ XVIII –≤–µ–∫–∞. –≠—Ç–æ –≤—Ä–µ–º—è –≤–µ–ª–∏–∫–∏—Ö –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –æ—Ç–∫—Ä—ã—Ç–∏–π, –Ω–∞—É—á–Ω—ã—Ö —Ä–µ–≤–æ–ª—é—Ü–∏–π –∏ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.</p>
        <p>–†–µ—Ñ–æ—Ä–º–∞—Ü–∏—è, –ü—Ä–æ—Å–≤–µ—â–µ–Ω–∏–µ, –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è —Ä–µ–≤–æ–ª—é—Ü–∏—è ‚Äî –≤—Å–µ —ç—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏–∑–º–µ–Ω–∏–ª–∏ –º–∏—Ä –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ –ø–æ—á–≤—É –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π —ç–ø–æ—Ö–∏.</p>
    </section>
    
    <section>
        <title>
            <p>–ì–ª–∞–≤–∞ 2. –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è</p>
        </title>
        <p>–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –æ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–∏–æ–¥ —Å XIX –≤–µ–∫–∞ –¥–æ –Ω–∞—à–∏—Ö –¥–Ω–µ–π. –≠—Ç–æ –≤—Ä–µ–º—è –±—É—Ä–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è –Ω–∞—É–∫–∏, —Ç–µ—Ö–Ω–∏–∫–∏ –∏ –æ–±—â–µ—Å—Ç–≤–∞.</p>
        <p>–î–≤–µ –º–∏—Ä–æ–≤—ã–µ –≤–æ–π–Ω—ã, —Ö–æ–ª–æ–¥–Ω–∞—è –≤–æ–π–Ω–∞, –≥–ª–æ–±–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî –≤—Å–µ —ç—Ç–∏ —Å–æ–±—ã—Ç–∏—è —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏—Ä.</p>
    </section>
</body>
</FictionBook>'''
    
    test_file_path = Path("data/raw/test_history_book.fb2")
    test_file_path.parent.mkdir(parents=True, exist_ok=True)
    
    with open(test_file_path, 'w', encoding='utf-8') as f:
        f.write(test_fb2_content)
    
    logger.info(f"‚úÖ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π FB2 —Ñ–∞–π–ª: {test_file_path}")

if __name__ == "__main__":
    test_fb2_reading()
